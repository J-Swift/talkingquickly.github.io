<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Indexes with Mongoid are not created automatically</title>
    
        <meta name="description" content="Blog by Ben Dixon, Ruby on Rails Developer, about rails, devops, docker, climbing and startups" />
    


    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="iwXSC2H2VSO9iPyrWjNj3Prlx4zJY-l0EJRGVkFuUHk" />


    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="RubyFlow"
    href="/rss.xml"/>

</head>
<body class="home-template">


    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/"><span class="blog-title">Home</span></a>
            //
            <a target="_blank" href='https://leanpub.com/deploying_rails_applications'>Deploying Rails Book</a>
        </header>

        <span class="post-meta">
        	
       	</span>

        <h1 class="post-title">Indexes with Mongoid are not created automatically</h1>

        <section class="post-content">
            <p>When coming from Mongoid from an Activerecord background, there are some
subtle differences around uniqueness and indexes which can cause hard to
debug problems.</p>

<!--more-->

<p>If you’re used to standard Active Record, then you’d expect the following:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">validates_uniqueness_of</span> <span class="ss">:attribute</span>
</code></pre></div>
<p>To throw an exception if you try to persist a model with a duplicate value for attribute. That comes with its own gotchas, in particular that the constraint exists at the ORM level not database level making it possible to create duplicate entries in specific race conditions. Mongoid has a gotcha of its own. It’s easy to assume that adding the following to a Mongoid document:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">index</span><span class="p">({</span><span class="ss">attribute</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span><span class="p">})</span>
</code></pre></div>
<p>will operate in the same way as <code>validates_uniqueness_of</code>.</p>

<p>It doesn’t.</p>

<p>What it does is tell Mongoid that there should be an index on “attribute” and that it should only allow unique values. It does not create this index. If you simple add that line, it will still be possible to create duplicate values for the attribute.</p>

<p>In order to have the index constraints enforced you must first create it using:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">mongoid</span><span class="p">:</span><span class="n">create_indexes</span>
</code></pre></div>
<p>This gotcha is particularly easy to get caught out by when deploying. A developer may add the index to the document, create the index on his local machine and commit the change. When it is deployed however, the index will not exist on production and so duplicate records can be created.</p>

<p>In traditional Active Record this problem was less common as migrations are usually run as part of the deployment process which includes index generation. If you’re deploying a mongoid application in production with Capistrano, it’s worth adding the above index generation command as an extra task, triggered by <code>after: update</code></p>

        </section>

        

        <footer class="post-footer">
          
          
            <section class="book">
  <header>
    <a href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer_image">
      <img
      src="/assets/images/deploying_rails_applications_cover.jpeg"
      />
    </a>
  </header>
  <article>
    <h4>Reliably Deploying Rails Applications Book</h4>
    <p>My book, Reliably Deploying Rails Applications covers every step of the deployment
    process from setting up a VPS from scratch with Chef, to deploying
    and day to day maintenance with Capistrano 3.</p>
    <p><a
      href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer"
      target="_blank">You
      can purchase it from leanpub here</a> or enter your email below to
    read a sample chapter.</p>
    <div id="mc_embed_signup">
<form action="http://hillsbede.us5.list-manage.com/subscribe/post?u=68b84d48aa7cec1155bee1a0c&amp;id=73f32eb74a" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" novalidate="">
  
  <input placeholder="Email Address" type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" style="height:28px;padding: 0 10px 0 10px;">

<input type="submit" value="Get the sample chapter" name="subscribe" id="mc-embedded-subscribe" class="button" style="background-color: #aaa;border: 0 none;border-radius: 4px;color: #FFFFFF;display: inline-block;font-size: 15px;font-weight: bold;height: 32px;line-height: 32px;margin: 0 5px 10px 10px;padding: 0 10px 0 10px;text-align: center;text-decoration: none;vertical-align: top;white-space: nowrap;width: auto;">
</form>
</div>
  
  </article>
</section>

          
          


            

        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
          <section class="copyright">All content copyright <a href="/about.html">Ben Dixon</a> &copy; &bull; All rights reserved. Twitter: <a href="http://www.twitter.com/talkingquickly" target="_blank">@talkingquickly</a></section>
             <section class="poweredby">Made with Jekyll and based on the <a href="http://github.com/rosario/kasper" target="_blank">Kasper theme</a></section>
        </div>
    </footer>


    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7333902-35']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
