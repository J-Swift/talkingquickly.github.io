<!DOCTYPE html>
<html>
<head>   
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Using Vagrant to test Chef Cookbooks</title>
    
        <meta name="description" content="Blog by Ben Dixon, Ruby on Rails Developer, about rails, devops, docker, climbing and startups" />
    
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="iwXSC2H2VSO9iPyrWjNj3Prlx4zJY-l0EJRGVkFuUHk" />

   
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="RubyFlow"
    href="/rss.xml"/>

</head>
<body class="home-template">

    
    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/"><span class="blog-title">Home</span></a>
            //
            <a target="_blank" href='https://leanpub.com/deploying_rails_applications'>Deploying Rails Book</a>
        </header>
        
        <span class="post-meta">
        	
       	</span>

        <h1 class="post-title">Using Vagrant to test Chef Cookbooks</h1>

        <section class="post-content">
            <p>Vagrant makes it easy to manage and distribute virtual machines. Vagrant is an extremely powerful tool in itself with a particular strength of making it easy to distribute local testing environments to developers which (almost) perfectly mirror your production configuration.</p>

<p>This section does not cover how to use Vagrant to create these re-usable environments. Instead it covers a very specific workflow I use for testing Chef Recipes.</p>

<p>This can be especially useful when you’re testing changes to recipes and want to see how it will interact with your existing production configuration.</p>

<p>For more on this workflow, read on, for a general introduction to the power of Vagrant, start here:</p>

<p><a href="http://docs.vagrantup.com/v2/getting-started/index.html">http://docs.vagrantup.com/v2/getting-started/index.html</a></p>

<h2>Getting Setup</h2>

<p>Go to <a href="http://downloads.vagrantup.com/">http://downloads.vagrantup.com/</a> and download then install the most recent version of Vagrant (I used 1.3.5). You’ll also need VirtualBox installed as Vagrant in this scenario acts as a tool for managing VirtualBox instances.</p>

<p>Make sure Vagrant is available in terminal by typing <code>vagrant</code> and ensuring you get output similar to the following:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">➜ ~ vagrant
Usage: vagrant <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span> <span class="nb">command</span> <span class="o">[]</span>
-v, --version Print the version and exit.
-h, --help Print this help.
....
</code></pre></div>
<p>If you get a command not found error, it may be necessary to restart your terminal.</p>

<p>For help on any individual command run</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">vagrant COMMAND -h
</code></pre></div>
<p>Create a new directory then:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">vagrant init precise64 http://files.vagrantup.com/precise64.box
</code></pre></div>
<p>This will generate a Vagrantfile</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">vagrant up
</code></pre></div>
<p>Will then download the pre created image of Ubuntu 12.04 and boot a Virtual Machine using it, don’t worry about the initial note saying that precise64 doesn’t yet exist</p>

<p>You can then ssh into this virtual machine using:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">vagrant ssh
</code></pre></div>
<p>Which will log you in as the vagrant user. Passwordless sudo is enabled so you don’t have to worry about default passwords</p>

<h2>SSHing in directly</h2>

<p>When testing chef cookbooks, roles and node definitions, I like to be able to apply a definition to my vagrant virtual machine in exactly the same way I will my production server. A pre-requisite for this is that I can interact with it without using any vagrant specific commands. Happily SSHing in the old fashioned way is very simple. Begin by running:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">vagrant ssh-config
</code></pre></div>
<p>This will give output something like the following:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">HostName 127.0.0.1
User vagrant
Port 2222
UserKnownHostsFile /dev/null
StrictHostKeyChecking no
PasswordAuthentication no
IdentityFile /Users/ben/.vagrant.d/insecure_private_key
IdentitiesOnly yes
LogLevel FATAL
</code></pre></div>
<p>Which shows the config which is being used by the <code>vagrant ssh</code> command.</p>

<p>From the above we can construct the following ssh command:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">ssh vagrant@127.0.0.1 -p <span class="m">2222</span> -i /Users/ben/.vagrant.d/insecure_private_key
</code></pre></div>
<p>Which means establish a connection to 127.0.0.1 on port 2222 using the vagrant generated private key file to authorise the user <code>vagrant</code>.</p>

<h2>Why not just use Vagrants built in chef and chef-solo support?</h2>

<p>Vagrant has excellant chef-solo support built in. Rather than using our existing node definition files, we can effectively include the data from a node definition file, in our vagrantfile. When <code>vagrant up</code> is run for the first time, the vagrant image will be automatically provisioned. This is very powerful when we’re using vagrant to make it easy for developers to provision environments which closely match production.</p>

<p>However when developing testing Chef cookbooks, role definitions and node definitions, I prefer the process of provisioning the Vagrant VM to be identical in as many ways as possible to the process of provisioning production and staging VM’s.</p>

<p>For me this means using exactly the same commands (knife solo prepare, knife solo cook etc). I strongly recommend reading http://docs.vagrantup.com/v2/provisioning/chef_solo.html to understand how chef provisioning can be built into a Vagrantfile if you do start using Vagrant for local development environments.</p>

<h2>Testing chef cookbooks</h2>

<p>Now we have a vagrant virtual machine which we can ssh into as we would any VPS, we can test our chef configuration on it.</p>

<p>Open a terminal in your chef repository, so in my case</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/proj/devops/rails_server_template
</code></pre></div>
<p>then install chef on your Vagrant VM:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">knife solo prepare vagrant@127.0.0.1 -p <span class="m">2222</span> -i /Users/ben/.vagrant.d/insecure_private_key
</code></pre></div>
<p>Where the port, ip and path to private key match the results of vagrant ssh-config before.</p>

<p>The output should be something like:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">Bootstrapping Chef...
 --2013-10-20 15:27:50-- https://www.opscode.com/chef/install.sh
 Resolving www.opscode.com <span class="o">(</span>www.opscode.com<span class="o">)</span>... 184.106.28.83
 Connecting to www.opscode.com <span class="o">(</span>www.opscode.com<span class="o">)</span><span class="p">|</span>184.106.28.83<span class="p">|</span>:443... connected.
 HTTP request sent, awaiting response... <span class="m">200</span> OK
 Length: <span class="m">6790</span> <span class="o">(</span>6.6K<span class="o">)</span> <span class="o">[</span>application/x-sh<span class="o">]</span>
 Saving to: <span class="sb">`</span>install.sh<span class="s1">&#39;</span>

<span class="s1">100%[======================================&gt;] 6,790 --.-K/s in 0s</span>

<span class="s1">2013-10-20 15:27:56 (799 MB/s) - `install.sh&#39;</span> saved <span class="o">[</span>6790/6790<span class="o">]</span>

Downloading Chef 11.6.2 <span class="k">for</span> ubuntu...
 Installing Chef 11.6.2
 Selecting previously unselected package chef.
 <span class="o">(</span>Reading database ... <span class="m">51095</span> files and directories currently installed.<span class="o">)</span>
 Unpacking chef <span class="o">(</span>from .../chef_11.6.2_amd64.deb<span class="o">)</span> ...
 Setting up chef <span class="o">(</span>11.6.2-1.ubuntu.12.04<span class="o">)</span> ...
 Thank you <span class="k">for</span> installing Chef!
</code></pre></div>
<p>This will have created an empty node definition file in <code>nodes/127.0.0.1</code>. To use this auto generated node definition file (<code>nodes/ip_address.json</code>) simply populate it and then enter:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">knife solo cook vagrant@127.0.0.1 -p <span class="m">2222</span> -i /Users/ben/.vagrant.d/insecure_private_key
</code></pre></div>
<p>Otherwise use</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">knife solo cook vagrant@127.0.0.1 nodes/my_node_definition.json -p <span class="m">2222</span> -i /Users/ben/.vagrant.d/insecure_private_key
</code></pre></div>
<p>Where <code>nodes/my_node_definition.json</code> is the path to an existing node definition.</p>

<p>The output from this will begin by installing the chef recipes from your Berksfile and then show the output from each individual recipe.</p>

<p>Once this process completes, the Vagrant VM should now be configured as per your chef definition.</p>

<h2>Users, Sudo and Root</h2>

<p>By default Vagrant sets up the <code>vagrant</code> user with the password <code>vagrant</code>. This user has passwordless sudo enabled so you never have to worry about default passwords (however read to the end for a gotcha here).</p>

<p>When you run <code>cook</code> for the first time using the vagrant user, chef will automatically try and use <code>sudo</code> where root access is required. The first time this will work correctly because the vagrant user has passwordless sudo enabled. If however the configuration you’re applying with chef includes defining who can sudo and how (such as my example rails server chef template), the next time you try and run <code>cook</code> for example to test another change to your chef repository, you’re likely to see something like the following:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">Running Chef on 127.0.0.1...
 Checking Chef version...
 Enter the password <span class="k">for</span> vagrant@127.0.0.1:
</code></pre></div>
<p>The default password for the <code>vagrant</code> user is <code>vagrant</code> however after entering, the process will still fail with the message:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">ERROR: RuntimeError: Couldn<span class="err">&#39;</span>t find Chef &gt;<span class="o">=</span>0.10.4 on 127.0.0.1. Please run <span class="sb">`</span>knife solo prepare vagrant@127.0.0.1 -i /Users/ben/.vagrant.d/insecure_private_key -p 2222<span class="sb">`</span> to ensure Chef is installed and up to date.
</code></pre></div>
<p>This is because the <code>vagrant</code> user is no longer in the sudoers file and so chefs attempt to run commands with sudo fails. You can verify that this is the case by running <code>vagrant ssh</code> from with your original vagrant folder which starts a shell with the vagrant user and then running <code>sudo ls</code> which will give output like:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">vagrant@precise64:~<span class="nv">$ </span>sudo ls
 <span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> vagrant:
 vagrant is not in the sudoers file. This incident will be reported.
</code></pre></div>
<p>Confirming that our vagrant user can no longer sudo.</p>

<p>There are various ways around this:</p>

<p>The first, and simplest, is to simply add the vagrant user to the sudoers group in your node defintion file. This has the added bonus that it allows commands like <code>vagrant halt</code> to continue working. This is generally the approach I use in day to day testing.</p>

<p>Some argue however that we should not modify the code we are testing in order to work with the tool we are testing it with. To avoid this we can modify our <code>cook</code> command going forward to execute using a user we know we have given sudo rights to, in the case of the rails<em>example</em>template this user would be deploy so going forward the command would be:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">knife solo cook deploy@127.0.0.1 nodes/my_node_definition.json -p <span class="m">2222</span> -i /Users/ben/.vagrant.d/insecure_private_key
</code></pre></div>
<p>Personally I prefer a hybrid. I generally add the vagrant user to the sudoers list in the node defintiion so that the vagrant interface can continue to function as usual however I use the above format when I want to test that provisioning as the deploy user works as expected.</p>

<h2>Conclusion</h2>

<p>If you use Chef Solo, this configuration allows you to use Vagrant to test cookbooks using local, disposable VM’s through a process that is almost identical to the production workflow. For more on Vagrant, such as how to forward ports, manage shared folders and package images for distribution, see the excellant Vagrant documentation at: <a href="http://docs.vagrantup.com/v2/getting-started/">http://docs.vagrantup.com/v2/getting-started/</a></p>

<div class="alsoread">
  <p><strong>Popular posts about deploying Rails apps</strong></p>
  <p>
    <a href="/2013/09/using-chef-to-provision-a-rails-and-postgres-server/">
      How to quickly provision a VPS for Rails using Chef
    </a>
    <br/>
    <a href="/2014/01/deploying-rails-apps-to-a-vps-with-capistrano-v3/">
      Deploying with Capistrano 3
    </a>
    <br/>
    <a href="/2013/12/tailing-log-files-with-capistrano-3/">
      Tailing log files with Capistrano 3
    </a>
    <br/>
    <a href="/2013/10/using-vagrant-to-test-chef-cookbooks/">
      Using Vagrant to test Chef Cookbooks
    </a>
    <br/>
    <a href="/2013/11/deploying-multiple-rails-apps-to-a-single-vps/">
      Deploying with Capistrano 2
    </a>
  </p>
</div>

        </section>

        

        <footer class="post-footer">
          
          
            <section class="book">
  <header>
    <a href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer_image">
      <img
      src="/assets/images/deploying_rails_applications_cover.jpeg"
      />
    </a>
  </header>
  <article>
    <h4>Reliably Deploying Rails Applications Book</h4>
    <p>My book, Reliably Deploying Rails Applications covers every step of the deployment
    process from setting up a VPS from scratch with Chef, to deploying
    and day to day maintenance with Capistrano 3.</p>
    <p><a
      href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer"
      target="_blank">You
      can purchase it from leanpub here</a> or enter your email below to
    read a sample chapter.</p>
    <div id="mc_embed_signup">
<form action="http://hillsbede.us5.list-manage.com/subscribe/post?u=68b84d48aa7cec1155bee1a0c&amp;id=73f32eb74a" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" novalidate="">
  
  <input placeholder="Email Address" type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" style="height:28px;padding: 0 10px 0 10px;">

<input type="submit" value="Get the sample chapter" name="subscribe" id="mc-embedded-subscribe" class="button" style="background-color: #aaa;border: 0 none;border-radius: 4px;color: #FFFFFF;display: inline-block;font-size: 15px;font-weight: bold;height: 32px;line-height: 32px;margin: 0 5px 10px 10px;padding: 0 10px 0 10px;text-align: center;text-decoration: none;vertical-align: top;white-space: nowrap;width: auto;">
</form>
</div>
  
  </article>
</section>

          
          

            
            
        	
        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
          <section class="copyright">All content copyright <a href="/about.html">Ben Dixon</a> &copy;  &bull; All rights reserved. Twitter: <a href="http://www.twitter.com/talkingquickly" target="_blank">@talkingquickly</a></section>
             <section class="poweredby">Made with Jekyll and based on the <a href="http://github.com/rosario/kasper" target="_blank">Kasper theme</a></section>
        </div>
    </footer>

    
    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7333902-35']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
