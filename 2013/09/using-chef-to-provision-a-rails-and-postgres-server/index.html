<!DOCTYPE html>
<html>
<head>   
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Using Chef to provision a Rails and Postgres server</title>
    
        <meta name="description" content="Blog by Ben Dixon, Ruby on Rails Developer, about rails, devops, docker, climbing and startups" />
    
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="iwXSC2H2VSO9iPyrWjNj3Prlx4zJY-l0EJRGVkFuUHk" />

   
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="RubyFlow"
    href="/rss.xml"/>

</head>
<body class="home-template">

    
    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/"><span class="blog-title">Home</span></a>
            //
            <a target="_blank" href='https://leanpub.com/deploying_rails_applications'>Deploying Rails Book</a>
        </header>
        
        <span class="post-meta">
        	
       	</span>

        <h1 class="post-title">Using Chef to provision a Rails and Postgres server</h1>

        <section class="post-content">
            <p>This is a brief overview of how to use chef to automate the provisioning of a server for a Ruby on Rails application. Sample code is provided as a starting point at <a href="https://github.com/TalkingQuickly/rails-server-template">https://github.com/TalkingQuickly/rails-server-template</a></p>

<h2>Our Requirements</h2>

<ul>
<li>Once setup, provisioning a new server should require just a few simple commands</li>
<li>It should be platform agnostic, any VPS provider will do</li>
<li>It should be easy to understand what’s happening, no “magic”</li>
<li>Once setup the server should take care of itself as much as possible and alert us if anything goes wrong</li>
</ul>

<h2>Our stack</h2>

<ul>
<li>Ruby 1.9.3+ (this can be selected)</li>
<li>Postgres</li>
<li>Redis</li>
<li>Chef</li>
</ul>

<p>Chef is a tool which allows us to define the commands to be run on a server using a ruby DSL. Commands are grouped into “recipes” which generally correspond to a piece of software to be installed. One or more recipes can be grouped into a cookbook, so for example a postgres cookbook could contain a recipe for a postgres client and another for a postgres server.</p>

<p>Data which varies from install to install – such as usernames, ports and paths – is defined in JSON files. Recipes and data can be grouped together in “roles,” for example a postgres-server role might combine a postgres recipe with a particular monitoring tool recipe and configuration.</p>

<p>Chef is capable of running on a central server and managing the propagation of recipes to multiple nodes. This is too complicated for the purposes of this single machine setup so we’ll be using the chef-solo gem (<a href="http://docs.opscode.com/chef_solo.html">http://docs.opscode.com/chef_solo.html</a>) along with the knife gem (<a href="http://docs.opscode.com/knife.html">http://docs.opscode.com/knife.html</a>)  to allow us to use cookbooks on the VPS directly from our workstation.</p>

<p>Finally we’ll be using berkshelf (<a href="http://berkshelf.com/">http://berkshelf.com/</a>) to manage our cookbooks and the dependencies between them, this can be thought of like bundler for chef cookbooks.</p>

<h2>Steps</h2>

<p>1) Install Tools</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">git clone git@github.com:TalkingQuickly/rails-server-template.git
</code></pre></div>
<p>The repository includes a <code>Gemfile</code> so simply run <code>bundle install</code> to install the required tools.</p>

<p>2) Define the server</p>

<p>First we need to define users, inside data_bags/users copy the file deploy.json.example to deploy.json.</p>

<p>Generate a password for your deploy user with the command:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">openssl passwd -1 <span class="s2">&quot;plaintextpassword&quot;</span>
</code></pre></div>
<p>And update deploy.json accordingly. Also copy your SSH public key (cat ~/.ssh/id_rsa.pub) into the public keys array.</p>

<p>Finally you need to download all the cookbooks required for the individual server components:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir cookbooks
bundle <span class="nb">exec </span>berks install --path ./cookbooks
</code></pre></div>
<p>3) Setup a VPS</p>

<p>This setup is designed to work on any Ubuntu 12.04 VPS, it has been tested on Linode, Rackspace and Digital Ocean. For initial experimentation I’d recommend Digital Ocean or for critical applications where support is key, Linode.</p>

<p>Once your VPS is up and running, copy your SSH key across:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">ssh-copy-id root@yourserverip
</code></pre></div>
<p>4) Provision the server</p>

<p>Begin by installing chef on the remote machine:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bundle <span class="nb">exec </span>knife solo prepare root@yourserverip
</code></pre></div>
<p>This will generate a file nodes/yourserverip.json. Copy the contents of rails_postgres_redis to this file and change the username and password for monit.</p>

<p>Use the same command as before (openssl passwd -1 “plaintextpassword”) to generate a password for postgresql and add this to the node definition file.</p>

<p>Now run:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bundle <span class="nb">exec </span>knife solo cook root@yourserverip
</code></pre></div>
<p>Sit back, relax and enjoy. This process takes quite a while and once it’s completed, you’ve got a server ready for a Rails + Postgres + Redis app.</p>

<h2>Next Steps</h2>

<p>You can read more about using Capistrano to deploy to VPS configured
with this method in <a href="/2013/11/deploying-multiple-rails-apps-to-a-single-vps">this post</a></p>

<p>Any queries or corrections you can find me on twitter;
<a href="http://www.twitter.com/talkingquickly">@talkingquickly</a></p>

<div class="alsoread">
  <p><strong>Popular posts about deploying Rails apps</strong></p>
  <p>
    <a href="/2013/09/using-chef-to-provision-a-rails-and-postgres-server/">
      How to quickly provision a VPS for Rails using Chef
    </a>
    <br/>
    <a href="/2014/01/deploying-rails-apps-to-a-vps-with-capistrano-v3/">
      Deploying with Capistrano 3
    </a>
    <br/>
    <a href="/2013/12/tailing-log-files-with-capistrano-3/">
      Tailing log files with Capistrano 3
    </a>
    <br/>
    <a href="/2013/10/using-vagrant-to-test-chef-cookbooks/">
      Using Vagrant to test Chef Cookbooks
    </a>
    <br/>
    <a href="/2013/11/deploying-multiple-rails-apps-to-a-single-vps/">
      Deploying with Capistrano 2
    </a>
  </p>
</div>

        </section>

        

        <footer class="post-footer">
          
          
            <section class="book">
  <header>
    <a href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer_image">
      <img
      src="/assets/images/deploying_rails_applications_cover.jpeg"
      />
    </a>
  </header>
  <article>
    <h4>Reliably Deploying Rails Applications Book</h4>
    <p>My book, Reliably Deploying Rails Applications covers every step of the deployment
    process from setting up a VPS from scratch with Chef, to deploying
    and day to day maintenance with Capistrano 3.</p>
    <p><a
      href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer"
      target="_blank">You
      can purchase it from leanpub here</a> or enter your email below to
    read a sample chapter.</p>
    <div id="mc_embed_signup">
<form action="http://hillsbede.us5.list-manage.com/subscribe/post?u=68b84d48aa7cec1155bee1a0c&amp;id=73f32eb74a" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" novalidate="">
  
  <input placeholder="Email Address" type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" style="height:28px;padding: 0 10px 0 10px;">

<input type="submit" value="Get the sample chapter" name="subscribe" id="mc-embedded-subscribe" class="button" style="background-color: #aaa;border: 0 none;border-radius: 4px;color: #FFFFFF;display: inline-block;font-size: 15px;font-weight: bold;height: 32px;line-height: 32px;margin: 0 5px 10px 10px;padding: 0 10px 0 10px;text-align: center;text-decoration: none;vertical-align: top;white-space: nowrap;width: auto;">
</form>
</div>
  
  </article>
</section>

          
          

            
            
        	
        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
          <section class="copyright">All content copyright <a href="/about.html">Ben Dixon</a> &copy;  &bull; All rights reserved. Twitter: <a href="http://www.twitter.com/talkingquickly" target="_blank">@talkingquickly</a></section>
             <section class="poweredby">Made with Jekyll and based on the <a href="http://github.com/rosario/kasper" target="_blank">Kasper theme</a></section>
        </div>
    </footer>

    
    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7333902-35']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
