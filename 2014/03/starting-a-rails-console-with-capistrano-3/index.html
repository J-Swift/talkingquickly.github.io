<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Starting a Rails Console with Capistrano 3</title>
    
        <meta name="description" content="Blog by Ben Dixon, Ruby on Rails Developer, about rails, kubernetes, docker, climbing and startups" />
    


    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="iwXSC2H2VSO9iPyrWjNj3Prlx4zJY-l0EJRGVkFuUHk" />


    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"/>
    <link rel="canonical" href="http://0.0.0.0:4000/2014/03/starting-a-rails-console-with-capistrano-3/">

</head>
<body class="home-template">


    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/"><span class="blog-title">Home</span></a>
            //
            <a target="_blank" href='https://leanpub.com/deploying_rails_applications'>Deploying Rails Book</a>
        </header>

        <span class="post-meta">
        	
       	</span>

        <h1 class="post-title">Starting a Rails Console with Capistrano 3</h1>

        <section class="post-content">
            <p>When deploying with Capistrano 3, it&#39;s often useful to be able to start a rails console without having to ssh into the target host and set it up manually. This can be particularly challenging if you&#39;re using rbenv as you have to ensure that <code>rails console</code> is called with suitable environment variables set set to ensure that the rbenv Ruby is used not the system Ruby.</p>

<!--more-->

<p>The below snippet works with Capistrano 3 and will attempt to use <code>rbenv_ruby</code> if it is configured in Capistrano, otherwise it will fall back to the default system Ruby.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">namespace</span> <span class="ss">:rails</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Start a rails console, for now just with the primary server&quot;</span>
  <span class="n">task</span> <span class="ss">:c</span> <span class="k">do</span>
    <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:app</span><span class="p">),</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">role</span><span class="o">|</span>
      <span class="n">rails_env</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:rails_env</span><span class="p">)</span>
      <span class="n">execute_remote_command_with_input</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">bundle_cmd_with_rbenv</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/script/rails console </span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute_remote_command_with_input</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:port</span><span class="p">)</span> <span class="o">||</span> <span class="mi">22</span>
    <span class="nb">puts</span> <span class="s2">&quot;opening a console on: </span><span class="si">#{</span><span class="n">host</span><span class="si">}</span><span class="s2">....&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;ssh -l </span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_user</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">host</span><span class="si">}</span><span class="s2"> -p </span><span class="si">#{</span><span class="n">port</span><span class="si">}</span><span class="s2"> -t &#39;cd </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">/current &amp;&amp; </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="nb">exec</span> <span class="n">cmd</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">bundle_cmd_with_rbenv</span>
    <span class="k">if</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_ruby</span><span class="p">)</span>
      <span class="s2">&quot;RBENV_VERSION=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_ruby</span><span class="p">)</span><span class="si">}</span><span class="s2"> RBENV_ROOT=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2">  </span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">),</span> <span class="s1">&#39;/bin/rbenv&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> exec bundle exec&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;ruby &quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<div class="alsoread">
  <p><strong>Popular posts about deploying Rails apps</strong></p>
  <p>
    <a href="/2013/09/using-chef-to-provision-a-rails-and-postgres-server/">
      How to quickly provision a VPS for Rails using Chef
    </a>
    <br/>
    <a href="/2014/01/deploying-rails-apps-to-a-vps-with-capistrano-v3/">
      Deploying with Capistrano 3
    </a>
    <br/>
    <a href="/2013/12/tailing-log-files-with-capistrano-3/">
      Tailing log files with Capistrano 3
    </a>
    <br/>
    <a href="/2013/10/using-vagrant-to-test-chef-cookbooks/">
      Using Vagrant to test Chef Cookbooks
    </a>
    <br/>
    <a href="/2013/11/deploying-multiple-rails-apps-to-a-single-vps/">
      Deploying with Capistrano 2
    </a>
  </p>
</div>

        </section>

        

        <footer class="post-footer">
          
          
            <section class="book">
  <header>
    <a href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer_image">
      <img
      src="/assets/images/deploying_rails_applications_cover.jpeg"
      />
    </a>
  </header>
  <article>
    <h4>Reliably Deploying Rails Applications Book</h4>
    <p>My book, Reliably Deploying Rails Applications covers every step of the deployment
    process from setting up a VPS from scratch with Chef, to deploying
    and day to day maintenance with Capistrano 3.</p>
    <p><a
      href="https://leanpub.com/deploying_rails_applications?utm_campaign=tlq_blog&utm_medium=referral&utm_source=footer"
      target="_blank">You
      can purchase or download a sample chapter it from leanpub here</a>
    </p>
  </article>
</section>

          
          


            

        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
          <section class="copyright">All content copyright <a href="/about.html">Ben Dixon</a> &copy; &bull; All rights reserved. Twitter: <a href="http://www.twitter.com/talkingquickly" target="_blank">@talkingquickly</a></section>
             <section class="poweredby">Made with Jekyll and based on the <a href="http://github.com/rosario/kasper" target="_blank">Kasper theme</a></section>
        </div>
    </footer>


    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7333902-35']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
